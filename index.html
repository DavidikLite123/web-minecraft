<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VoxelCraft â€” Multiplayer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;font-family:'Segoe UI',system-ui,sans-serif;touch-action:none;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
canvas{display:block}

/* â•â•â• MENU â•â•â• */
#menu{position:fixed;inset:0;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0e14 0%,#1a1e2e 50%,#0a0e14 100%);color:#fff}
#menu::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='40' height='40' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='8' height='8' fill='rgba(255,255,255,.012)'/%3E%3Crect x='20' width='8' height='8' fill='rgba(255,255,255,.012)'/%3E%3Crect y='20' width='8' height='8' fill='rgba(255,255,255,.012)'/%3E%3Crect x='20' y='20' width='8' height='8' fill='rgba(255,255,255,.012)'/%3E%3C/svg%3E");animation:scroll 25s linear infinite}
@keyframes scroll{to{background-position:40px 40px}}

.mc{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%}
.title{font-size:clamp(2.2rem,8vw,4.5rem);font-weight:900;letter-spacing:3px;background:linear-gradient(135deg,#4ade80,#38bdf8,#4ade80);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 3s ease infinite}
@keyframes shine{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.sub{color:rgba(255,255,255,.3);font-size:.8rem;letter-spacing:5px;text-transform:uppercase;margin:4px 0 28px}

.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:28px 32px;width:min(400px,90vw);backdrop-filter:blur(16px)}
.card h3{font-size:.7rem;color:rgba(255,255,255,.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.card input{width:100%;padding:13px 16px;border-radius:11px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-size:1rem;outline:none;transition:.2s}
.card input:focus{border-color:rgba(74,222,128,.5);box-shadow:0 0 0 3px rgba(74,222,128,.08)}
.card input::placeholder{color:rgba(255,255,255,.2)}
.sep{height:1px;background:rgba(255,255,255,.06);margin:20px 0}
.btn{width:100%;padding:14px;margin-top:8px;border:none;border-radius:13px;font-size:.95rem;font-weight:700;cursor:pointer;color:#fff;letter-spacing:.3px;transition:.15s;position:relative;overflow:hidden}
.btn:active{transform:scale(.97)}
.btn::after{content:'';position:absolute;inset:0;background:linear-gradient(rgba(255,255,255,.12),transparent);pointer-events:none}
.bg{background:linear-gradient(135deg,#22c55e,#16a34a);box-shadow:0 4px 18px rgba(34,197,94,.25)}
.bb{background:linear-gradient(135deg,#2563eb,#3b82f6);box-shadow:0 4px 18px rgba(59,130,246,.25)}
.bp{background:linear-gradient(135deg,#7c3aed,#8b5cf6);box-shadow:0 4px 18px rgba(139,92,246,.25)}
.bo{background:linear-gradient(135deg,#d97706,#f59e0b);box-shadow:0 4px 18px rgba(245,158,11,.25)}
.bd{background:rgba(255,255,255,.05);box-shadow:none;font-weight:400;font-size:.82rem;color:rgba(255,255,255,.55)}

#roomBox{display:none;margin-top:14px;padding:18px;background:rgba(74,222,128,.05);border:1px solid rgba(74,222,128,.12);border-radius:14px;text-align:center}
#roomBox .rl{font-size:.65rem;color:rgba(255,255,255,.35);letter-spacing:2px;text-transform:uppercase}
#roomBox .rid{font-size:2.6rem;font-weight:900;letter-spacing:10px;color:#4ade80;font-family:'Courier New',monospace;margin:6px 0}
#roomBox .rh{font-size:.72rem;color:rgba(255,255,255,.25)}
.rbtns{display:flex;gap:6px;margin-top:10px}
.rbtns .btn{flex:1;margin:0;padding:11px;font-size:.82rem}

#joinBox{display:none}
#joinBox input{text-align:center;font-size:1.5rem;letter-spacing:8px;text-transform:uppercase;font-family:'Courier New',monospace;font-weight:700}

#log{margin-top:16px;text-align:center;font-size:.8rem;min-height:22px;color:rgba(255,255,255,.5)}
.dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:5px;vertical-align:middle}
.dl{background:#f59e0b;animation:blink 1s ease infinite}
.dok{background:#22c55e}
.derr{background:#ef4444}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

#plist{margin-top:8px;font-size:.72rem;color:rgba(255,255,255,.3);text-align:center}

/* â•â•â• HUD â•â•â• */
#hud{position:fixed;inset:0;z-index:100;pointer-events:none;display:none}
#cross{position:absolute;top:50%;left:50%;width:22px;height:22px;transform:translate(-50%,-50%)}
#cross::before,#cross::after{content:'';position:absolute;background:rgba(255,255,255,.75);border-radius:1px}
#cross::before{width:2px;height:16px;top:50%;left:50%;transform:translate(-50%,-50%)}
#cross::after{width:16px;height:2px;top:50%;left:50%;transform:translate(-50%,-50%)}
#xyz{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.5);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:7px;font-size:.68rem;font-family:'Courier New',monospace;backdrop-filter:blur(4px)}
#net{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.5);color:#fff;padding:5px 10px;border-radius:7px;font-size:.72rem;display:flex;align-items:center;gap:5px;backdrop-filter:blur(4px)}
#bname{position:absolute;bottom:64px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.5);color:#fff;padding:5px 16px;border-radius:9px;font-size:.78rem;white-space:nowrap;backdrop-filter:blur(4px)}

/* Hotbar */
#hotbar{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:2px;pointer-events:auto}
.hs{width:42px;height:42px;background:rgba(0,0,0,.5);border:2px solid rgba(255,255,255,.1);border-radius:5px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;backdrop-filter:blur(4px);transition:.15s}
.hs.act{border-color:#4ade80;box-shadow:0 0 10px rgba(74,222,128,.35)}
.hs canvas{width:26px;height:26px;border-radius:2px;image-rendering:pixelated}
.hs .sn{position:absolute;top:1px;left:3px;font-size:.45rem;color:rgba(255,255,255,.3)}

/* â•â•â• CHAT â•â•â• */
#chatWrap{position:fixed;bottom:58px;left:8px;z-index:300;width:min(340px,70vw);pointer-events:none}
#chatMsgs{max-height:140px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;padding:3px}
#chatMsgs::-webkit-scrollbar{width:0}
.cm{background:rgba(0,0,0,.5);color:#fff;padding:3px 9px;border-radius:5px;font-size:.74rem;word-break:break-word;width:fit-content;max-width:100%;backdrop-filter:blur(4px);animation:cmIn .2s}
@keyframes cmIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.cm b{font-weight:700}
#chatInWrap{display:none;margin-top:3px;pointer-events:auto}
#chatIn{width:100%;padding:9px 12px;border:1px solid rgba(74,222,128,.2);border-radius:9px;background:rgba(0,0,0,.7);color:#fff;font-size:.82rem;outline:none;backdrop-filter:blur(8px)}
#chatBtnM{display:none;position:fixed;bottom:66px;left:8px;z-index:301;width:38px;height:38px;border-radius:50%;border:none;background:rgba(255,255,255,.1);color:#fff;font-size:1rem;pointer-events:auto;cursor:pointer;backdrop-filter:blur(4px)}

/* â•â•â• MOBILE â•â•â• */
#mobUI{position:fixed;inset:0;z-index:200;pointer-events:none;display:none}
#joyArea{position:absolute;bottom:18px;left:14px;width:130px;height:130px;pointer-events:auto}
#joyBase{width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.04);border:2px solid rgba(255,255,255,.1);position:relative}
#joyKnob{width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.18);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);transition:none}
.mb{pointer-events:auto;border:none;border-radius:50%;background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.1);color:rgba(255,255,255,.65);font-weight:700;display:flex;align-items:center;justify-content:center;position:absolute;backdrop-filter:blur(4px);transition:.1s}
.mb:active{background:rgba(255,255,255,.18)}
#mbJ{width:66px;height:66px;bottom:22px;right:18px;font-size:1.4rem}
#mbB{width:54px;height:54px;bottom:108px;right:86px;font-size:.75rem}
#mbP{width:54px;height:54px;bottom:108px;right:18px;font-size:.75rem}

/* â•â•â• PAUSE â•â•â• */
#pause{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.7);display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff;backdrop-filter:blur(5px)}
#pause h2{font-size:1.8rem;margin-bottom:18px;font-weight:300}
#pause .btn{width:200px}

/* â•â•â• RECONNECT â•â•â• */
#reconn{position:fixed;top:55px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(239,68,68,.9);color:#fff;padding:10px 24px;border-radius:11px;font-size:.85rem;font-weight:600;display:none;backdrop-filter:blur(8px);box-shadow:0 4px 18px rgba(239,68,68,.25);animation:sld .3s}
@keyframes sld{from{opacity:0;transform:translateX(-50%) translateY(-15px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu">
 <div class="mc">
  <div class="title">VOXELCRAFT</div>
  <div class="sub">Multiplayer Edition</div>
  <div class="card" id="mainC">
   <h3>ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼</h3>
   <input id="iNick" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ..." maxlength="16">
   <div class="sep"></div>
   <button class="btn bg" id="bHost">ğŸŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ñ€</button>
   <button class="btn bb" id="bJoinS">ğŸ”— ĞŸÑ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒÑÑ</button>
   <div id="roomBox">
    <div class="rl">ĞšĞ¾Ğ´ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹</div>
    <div class="rid" id="rId">----</div>
    <div class="rh">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ´ Ğ´Ñ€ÑƒĞ³Ñƒ</div>
    <div class="rbtns">
     <button class="btn bd" id="bCopy">ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
     <button class="btn bo" id="bPlay">ğŸš€ Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ</button>
    </div>
   </div>
   <div id="plist"></div>
  </div>
  <div class="card" id="joinBox">
   <h3>ĞšĞ¾Ğ´ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹</h3>
   <input id="iRoom" placeholder="XXXX" maxlength="6">
   <button class="btn bp" id="bConn">âš¡ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ</button>
   <button class="btn bd" id="bBack">â† ĞĞ°Ğ·Ğ°Ğ´</button>
  </div>
  <div id="log"></div>
 </div>
</div>

<!-- HUD -->
<div id="hud">
 <div id="cross"></div>
 <div id="xyz">0, 0, 0</div>
 <div id="net"><span class="dot dok"></span><span id="nTxt">ğŸ‘¤ 1</span></div>
 <div id="bname">Ğ¢Ñ€Ğ°Ğ²Ğ°</div>
 <div id="hotbar"></div>
</div>

<!-- CHAT -->
<div id="chatWrap"><div id="chatMsgs"></div><div id="chatInWrap"><input id="chatIn" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." maxlength="200"></div></div>
<button id="chatBtnM">ğŸ’¬</button>

<!-- MOBILE -->
<div id="mobUI">
 <div id="joyArea"><div id="joyBase"><div id="joyKnob"></div></div></div>
 <button class="mb" id="mbJ">â¬†</button>
 <button class="mb" id="mbB">â›</button>
 <button class="mb" id="mbP">ğŸ§±</button>
</div>

<!-- PAUSE -->
<div id="pause">
 <h2>ĞŸĞ°ÑƒĞ·Ğ°</h2>
 <button class="btn bg" id="bResume">â–¶ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ</button>
 <button class="btn bd" id="bQuit" style="margin-top:8px">ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
</div>

<!-- RECONNECT -->
<div id="reconn">âš  Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾ â€” Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...</div>

<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CS=16, CH=64, RD=4;
const GRAV=28, JVEL=9.5, MSPD=6;
const PH=1.8, EYE=1.6, PR=0.28; // Player height=1.8, eye=1.6, radius=0.28
const MOB=/Android|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent)||('ontouchstart' in window&&innerWidth<1100);
const NHZ=10;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BLOCK TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BT={
 0:{n:'Ğ’Ğ¾Ğ·Ğ´ÑƒÑ…',s:false},1:{n:'Ğ¢Ñ€Ğ°Ğ²Ğ°',s:true},2:{n:'Ğ—ĞµĞ¼Ğ»Ñ',s:true},
 3:{n:'ĞšĞ°Ğ¼ĞµĞ½ÑŒ',s:true},4:{n:'Ğ”ĞµÑ€ĞµĞ²Ğ¾',s:true},5:{n:'Ğ›Ğ¸ÑÑ‚Ğ²Ğ°',s:true},
 6:{n:'ĞŸĞµÑĞ¾Ğº',s:true},7:{n:'Ğ’Ğ¾Ğ´Ğ°',s:false},8:{n:'Ğ”Ğ¾ÑĞºĞ¸',s:true},
 9:{n:'ĞšĞ¸Ñ€Ğ¿Ğ¸Ñ‡',s:true},10:{n:'Ğ‘ÑƒĞ»Ñ‹Ğ¶Ğ½Ğ¸Ğº',s:true}
};
const HBB=[1,2,3,4,5,6,8,9,10];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROCEDURAL TEXTURES (Canvas API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _tx={};
function mkTex(id){
 if(_tx[id])return _tx[id];
 const S=64,cv=document.createElement('canvas');cv.width=cv.height=S;
 const c=cv.getContext('2d');
 let sd=id*9973+541;
 const R=()=>{sd=(sd*16807+11)%2147483647;return(sd&0x7fffffff)/2147483647};
 const noise=(x,y,sc)=>{
  const ix=Math.floor(x/sc),iy=Math.floor(y/sc);
  const fx=(x/sc)-ix,fy=(y/sc)-iy;
  const sfx=fx*fx*(3-2*fx),sfy=fy*fy*(3-2*fy);
  const sd2=id*37+1;
  const h=(a,b)=>{let s=a*374761393+b*668265263+sd2;s=(s^(s>>13))*1274126177;return((s^(s>>16))&0xff)/255};
  return h(ix,iy)*(1-sfx)*(1-sfy)+h(ix+1,iy)*sfx*(1-sfy)+h(ix,iy+1)*(1-sfx)*sfy+h(ix+1,iy+1)*sfx*sfy;
 };

 switch(id){
  case 1: // Grass top
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,8)*.3+noise(x,y,4)*.2+noise(x,y,16)*.3;
    const g=65+n*95|0,r=35+n*45|0,b=18+n*22|0;
    c.fillStyle=`rgb(${r},${g},${b})`;c.fillRect(x,y,1,1);
   }
   // Grass blades
   for(let i=0;i<200;i++){const x=R()*S|0,y=R()*S|0;c.fillStyle=`rgba(${25+R()*40|0},${90+R()*80|0},${15+R()*20|0},.5)`;c.fillRect(x,y,1,1+R()*3|0)}
   break;
  case 11: // Grass side
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,6)*.35+noise(x,y,3)*.2;
    if(y<8){const g=60+n*90|0;c.fillStyle=`rgb(${30+n*35|0},${g},${15+n*20|0})`}
    else{const v=85+n*65|0;c.fillStyle=`rgb(${v},${v*.72|0},${v*.38|0})`}
    c.fillRect(x,y,1,1);
   }
   for(let i=0;i<30;i++){c.fillStyle='rgba(50,120,30,.5)';c.fillRect(R()*S|0,7,1,1+R()*4|0)}
   break;
  case 2: // Dirt
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,7)*.4+noise(x,y,3)*.25;
    const v=90+n*60|0;c.fillStyle=`rgb(${v},${v*.72|0},${v*.35|0})`;c.fillRect(x,y,1,1);
   }
   for(let i=0;i<50;i++){c.fillStyle='rgba(45,25,8,.3)';const s=2+R()*3|0;c.fillRect(R()*S|0,R()*S|0,s,s)}
   break;
  case 3: // Stone
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,10)*.35+noise(x,y,5)*.25+noise(x,y,2)*.15;
    const v=85+n*85|0;c.fillStyle=`rgb(${v},${v},${v+5|0})`;c.fillRect(x,y,1,1);
   }
   for(let i=0;i<20;i++){c.strokeStyle=`rgba(40,40,40,.15)`;c.lineWidth=1;c.beginPath();c.moveTo(R()*S,R()*S);c.lineTo(R()*S,R()*S);c.stroke()}
   break;
  case 4: // Wood
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y*3,8)*.4+noise(x,y,3)*.2;
    const r=75+n*55|0,g=48+n*30|0,b=20+n*18|0;
    c.fillStyle=`rgb(${r},${g},${b})`;c.fillRect(x,y,1,1);
   }
   for(let y=0;y<S;y+=3+R()*5|0){c.fillStyle=`rgba(35,20,8,.12)`;c.fillRect(0,y,S,1)}
   break;
  case 5: // Leaves
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,6)*.5+noise(x,y,3)*.3;
    c.fillStyle=`rgb(${15+n*50|0},${70+n*100|0},${12+n*40|0})`;c.fillRect(x,y,1,1);
   }
   for(let i=0;i<80;i++){c.fillStyle='rgba(0,30,0,.2)';c.fillRect(R()*S|0,R()*S|0,2,2)}
   break;
  case 6: // Sand
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,8)*.3+noise(x,y,3)*.2;
    const v=180+n*60|0;c.fillStyle=`rgb(${v},${v-12|0},${v-50|0})`;c.fillRect(x,y,1,1);
   }
   break;
  case 7: // Water
   c.fillStyle='rgba(30,85,185,.5)';c.fillRect(0,0,S,S);
   for(let i=0;i<150;i++){c.fillStyle='rgba(50,125,235,.2)';c.fillRect(R()*S|0,R()*S|0,4+R()*8|0,1)}
   break;
  case 8: // Planks
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y*2,10)*.3+noise(x,y,4)*.15;
    const r=135+n*40|0,g=100+n*35|0,b=60+n*30|0;
    c.fillStyle=`rgb(${r},${g},${b})`;c.fillRect(x,y,1,1);
   }
   for(let i=0;i<4;i++){c.strokeStyle='rgba(60,35,10,.15)';c.lineWidth=1;c.strokeRect(0,i*16,S,16)}
   break;
  case 9: // Brick
   c.fillStyle='#9a3a28';c.fillRect(0,0,S,S);
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){const n=noise(x,y,5)*.2;c.fillStyle=`rgba(${140+n*80|0},${45+n*35|0},${25+n*25|0},.4)`;c.fillRect(x,y,1,1)}
   c.strokeStyle='#c0b088';c.lineWidth=2;
   for(let r=0;r<8;r++){const y=r*8;c.strokeRect(0,y,S,8);const o=r%2?8:0;for(let cl=0;cl<4;cl++)c.strokeRect(o+cl*16,y,16,8)}
   break;
  case 10: // Cobble
   for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const n=noise(x,y,9)*.35+noise(x,y,4)*.25;
    const v=68+n*80|0;c.fillStyle=`rgb(${v},${v},${v})`;c.fillRect(x,y,1,1);
   }
   for(let i=0;i<35;i++){const bx=R()*S|0,by=R()*S|0,bw=4+R()*10|0,bh=4+R()*10|0;
   c.strokeStyle='rgba(30,30,30,.25)';c.lineWidth=1;c.strokeRect(bx,by,bw,bh)}
   break;
 }
 const tex=new THREE.CanvasTexture(cv);
 tex.magFilter=THREE.NearestFilter;tex.minFilter=THREE.NearestFilter;
 tex.wrapS=tex.wrapT=THREE.RepeatWrapping;
 _tx[id]=tex;return tex;
}

function bTexIds(bt){
 if(bt===1)return[11,11,1,2,11,11]; // grass: sides=11,top=1,bottom=2
 return[bt,bt,bt,bt,bt,bt];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOISE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Noise{
 constructor(seed){
  this.p=new Uint8Array(512);
  let s=seed||1;
  const nx=()=>{s=(s*16807)%2147483647;return(s&0x7fffffff)/0x7fffffff};
  const pm=new Uint8Array(256);for(let i=0;i<256;i++)pm[i]=i;
  for(let i=255;i>0;i--){const j=nx()*i|0;[pm[i],pm[j]]=[pm[j],pm[i]]}
  for(let i=0;i<512;i++)this.p[i]=pm[i&255];
 }
 _f(t){return t*t*(3-2*t)}
 _h(x,y){return this.p[(this.p[x&255]+y)&511]/255}
 _l(a,b,t){return a+t*(b-a)}
 n2(x,y){
  const ix=Math.floor(x),iy=Math.floor(y);
  const fx=this._f(x-ix),fy=this._f(y-iy);
  return this._l(this._l(this._h(ix,iy),this._h(ix+1,iy),fx),this._l(this._h(ix,iy+1),this._h(ix+1,iy+1),fx),fy);
 }
 fbm(x,y,oct=4){
  let v=0,a=.5,f=1,m=0;
  for(let i=0;i<oct;i++){v+=this.n2(x*f,y*f)*a;m+=a;a*=.5;f*=2}
  return v/m;
 }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ren=new THREE.WebGLRenderer({antialias:!MOB,powerPreference:'high-performance'});
ren.setSize(innerWidth,innerHeight);
ren.setPixelRatio(Math.min(devicePixelRatio,MOB?1.5:2));
ren.setClearColor(0x7ec8e3);
if(!MOB){ren.shadowMap.enabled=true;ren.shadowMap.type=THREE.PCFSoftShadowMap}
document.body.appendChild(ren.domElement);

const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x7ec8e3,25,RD*CS+16);
const cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,300);

// Lighting
scene.add(new THREE.HemisphereLight(0x87ceeb,0x556b2f,.55));
scene.add(new THREE.AmbientLight(0xffffff,.3));
const sun=new THREE.DirectionalLight(0xfff5e0,.9);
sun.position.set(50,90,35);
if(!MOB){sun.castShadow=true;const sc=sun.shadow.camera;sun.shadow.mapSize.set(1024,1024);sc.near=1;sc.far=220;sc.left=sc.bottom=-65;sc.right=sc.top=65}
scene.add(sun);

// Sky
const skyM=new THREE.Mesh(
 new THREE.SphereGeometry(200,16,16),
 new THREE.ShaderMaterial({side:THREE.BackSide,
  vertexShader:`varying vec3 vP;void main(){vP=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
  fragmentShader:`varying vec3 vP;void main(){float h=normalize(vP).y;vec3 a=vec3(.47,.72,.94);vec3 b=vec3(.78,.90,1.);gl_FragColor=vec4(mix(b,a,max(h,0.)),1.);}`
 })
);scene.add(skyM);

const sunV=new THREE.Mesh(new THREE.SphereGeometry(4,10,10),new THREE.MeshBasicMaterial({color:0xffee88}));
sunV.position.copy(sun.position);scene.add(sunV);

// Clouds
const cldG=new THREE.Group();scene.add(cldG);
const cldM=new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:.5});
for(let i=0;i<20;i++){
 const cg=new THREE.Group();const n=3+Math.random()*5|0;
 for(let j=0;j<n;j++){const s=3+Math.random()*5;const cm=new THREE.Mesh(new THREE.BoxGeometry(s,1,s*.6),cldM);cm.position.set(j*3-n,0,(Math.random()-.5)*3);cg.add(cm)}
 cg.position.set((Math.random()-.5)*200,48+Math.random()*14,(Math.random()-.5)*200);
 cldG.add(cg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wSeed=42,noise=new Noise(wSeed);
const blkHist=[]; // for sync

class World{
 constructor(){this.chunks=new Map();this.meshes=new Map();this.dirty=new Set()}
 _k(cx,cz){return cx+','+cz}
 _i(lx,ly,lz){return ly*CS*CS+lz*CS+lx}

 getChunk(cx,cz){const k=this._k(cx,cz);if(!this.chunks.has(k))this._gen(cx,cz);return this.chunks.get(k)}

 _gen(cx,cz){
  const k=this._k(cx,cz),d=new Uint8Array(CS*CS*CH),WL=10;
  for(let lx=0;lx<CS;lx++)for(let lz=0;lz<CS;lz++){
   const wx=cx*CS+lx,wz=cz*CS+lz;
   const h1=noise.fbm(wx*.008,wz*.008,5);
   const h2=noise.fbm(wx*.03,wz*.03,3)*.25;
   const h3=noise.fbm(wx*.06,wz*.06,2)*.1;
   let h=Math.floor((h1+h2+h3)*22+14);
   h=Math.max(1,Math.min(CH-3,h));
   for(let ly=0;ly<CH;ly++){
    let b=0;
    if(ly===0)b=3;
    else if(ly<h-4)b=3;
    else if(ly<h)b=2;
    else if(ly===h)b=h<=WL+1?6:1;
    else if(ly<=WL&&ly>h)b=7;
    d[this._i(lx,ly,lz)]=b;
   }
   // Trees
   if(h>WL+2&&noise.n2(wx*.47,wz*.47)>.77){
    const th=4+Math.floor(noise.n2(wx*3.1,wz*3.1)*3);
    for(let ty=1;ty<=th;ty++){const by=h+ty;if(by<CH)d[this._i(lx,by,lz)]=4}
    const cb=h+th-1;
    for(let dx=-2;dx<=2;dx++)for(let dz=-2;dz<=2;dz++)for(let dy=0;dy<=2;dy++){
     if(Math.abs(dx)===2&&Math.abs(dz)===2&&dy===2)continue;
     const nx=lx+dx,nz=lz+dz,ny=cb+dy;
     if(nx>=0&&nx<CS&&nz>=0&&nz<CS&&ny<CH&&d[this._i(nx,ny,nz)]===0)d[this._i(nx,ny,nz)]=5;
    }
   }
  }
  this.chunks.set(k,d);this.dirty.add(k);
 }

 getB(wx,wy,wz){
  if(wy<0||wy>=CH)return 0;
  const cx=Math.floor(wx/CS),cz=Math.floor(wz/CS);
  const lx=((wx%CS)+CS)%CS,lz=((wz%CS)+CS)%CS;
  return this.getChunk(cx,cz)[this._i(lx,wy,lz)];
 }

 setB(wx,wy,wz,b){
  if(wy<0||wy>=CH)return;
  const cx=Math.floor(wx/CS),cz=Math.floor(wz/CS);
  const lx=((wx%CS)+CS)%CS,lz=((wz%CS)+CS)%CS;
  this.getChunk(cx,cz)[this._i(lx,wy,lz)]=b;
  const k=this._k(cx,cz);this.dirty.add(k);
  if(lx===0)this.dirty.add(this._k(cx-1,cz));
  if(lx===CS-1)this.dirty.add(this._k(cx+1,cz));
  if(lz===0)this.dirty.add(this._k(cx,cz-1));
  if(lz===CS-1)this.dirty.add(this._k(cx,cz+1));
 }

 isS(wx,wy,wz){const b=this.getB(wx,wy,wz);return BT[b]?BT[b].s:false}

 buildMesh(cx,cz){
  const k=this._k(cx,cz),data=this.getChunk(cx,cz);
  if(this.meshes.has(k)){const o=this.meshes.get(k);scene.remove(o);o.children.forEach(ch=>{ch.geometry.dispose();ch.material.dispose()});this.meshes.delete(k)}
  const F=[
   {d:[1,0,0],c:[[1,0,0],[1,1,0],[1,1,1],[1,0,1]],n:[1,0,0],fi:0,uv:[[0,0],[0,1],[1,1],[1,0]]},
   {d:[-1,0,0],c:[[0,0,1],[0,1,1],[0,1,0],[0,0,0]],n:[-1,0,0],fi:1,uv:[[0,0],[0,1],[1,1],[1,0]]},
   {d:[0,1,0],c:[[0,1,1],[1,1,1],[1,1,0],[0,1,0]],n:[0,1,0],fi:2,uv:[[0,0],[1,0],[1,1],[0,1]]},
   {d:[0,-1,0],c:[[0,0,0],[1,0,0],[1,0,1],[0,0,1]],n:[0,-1,0],fi:3,uv:[[0,0],[1,0],[1,1],[0,1]]},
   {d:[0,0,1],c:[[0,0,1],[1,0,1],[1,1,1],[0,1,1]],n:[0,0,1],fi:4,uv:[[0,0],[1,0],[1,1],[0,1]]},
   {d:[0,0,-1],c:[[1,0,0],[0,0,0],[0,1,0],[1,1,0]],n:[0,0,-1],fi:5,uv:[[0,0],[1,0],[1,1],[0,1]]}
  ];
  const bk={};
  for(let ly=0;ly<CH;ly++)for(let lz=0;lz<CS;lz++)for(let lx=0;lx<CS;lx++){
   const bl=data[this._i(lx,ly,lz)];if(bl===0)continue;
   const tids=bTexIds(bl),wx=cx*CS+lx,wz=cz*CS+lz;
   for(const f of F){
    const nx=wx+f.d[0],ny=ly+f.d[1],nz=wz+f.d[2];
    const nb=this.getB(nx,ny,nz);
    if(nb!==0&&!(bl!==7&&nb===7))continue;
    if(bl===7&&nb===7)continue;
    const tid=tids[f.fi];
    if(!bk[tid])bk[tid]={p:[],n:[],u:[],idx:[],vi:0};
    const b=bk[tid];
    const sh=f.d[1]===1?1:f.d[1]===-1?.65:f.d[0]!==0?.8:.88;
    for(let i=0;i<4;i++){
     b.p.push(lx+f.c[i][0],ly+f.c[i][1],lz+f.c[i][2]);
     b.n.push(f.n[0]*sh,f.n[1]*sh,f.n[2]*sh);
     b.u.push(f.uv[i][0],f.uv[i][1]);
    }
    b.idx.push(b.vi,b.vi+1,b.vi+2,b.vi,b.vi+2,b.vi+3);b.vi+=4;
   }
  }
  const grp=new THREE.Group();grp.position.set(cx*CS,0,cz*CS);
  for(const tid in bk){
   const b=bk[tid];if(!b.p.length)continue;
   const geo=new THREE.BufferGeometry();
   geo.setAttribute('position',new THREE.Float32BufferAttribute(b.p,3));
   geo.setAttribute('normal',new THREE.Float32BufferAttribute(b.n,3));
   geo.setAttribute('uv',new THREE.Float32BufferAttribute(b.u,2));
   geo.setIndex(b.idx);
   const isW=parseInt(tid)===7;
   const mat=new THREE.MeshLambertMaterial({map:mkTex(parseInt(tid)),transparent:isW,opacity:isW?.5:1});
   const m=new THREE.Mesh(geo,mat);
   if(!MOB){m.castShadow=true;m.receiveShadow=true}
   grp.add(m);
  }
  scene.add(grp);this.meshes.set(k,grp);
 }

 update(px,pz){
  const pcx=Math.floor(px/CS),pcz=Math.floor(pz/CS),need=new Set();
  for(let dx=-RD;dx<=RD;dx++)for(let dz=-RD;dz<=RD;dz++){
   if(dx*dx+dz*dz>(RD+.5)*(RD+.5))continue;
   const cx=pcx+dx,cz=pcz+dz,k=this._k(cx,cz);need.add(k);this.getChunk(cx,cz);
  }
  let built=0;
  for(const k of this.dirty){
   if(!need.has(k))continue;
   const[cx,cz]=k.split(',').map(Number);this.buildMesh(cx,cz);this.dirty.delete(k);
   if(++built>=3)break;
  }
  for(const[k,m]of this.meshes)if(!need.has(k)){scene.remove(m);m.children.forEach(ch=>{ch.geometry.dispose();ch.material.dispose()});this.meshes.delete(k)}
 }
}

let world=new World();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER CONTROLLER â€” Height 1.8, Eye 1.6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Player{
 constructor(){
  this.pos=new THREE.Vector3(8,30,8);
  this.vel=new THREE.Vector3();
  this.yaw=0;this.pitch=0;this.grounded=false;this.slot=0;
  this._spawn();
 }
 _spawn(){
  for(let y=CH-1;y>=0;y--)if(world.isS(8,y,8)){this.pos.y=y+1+EYE;return}
  this.pos.y=20+EYE;
 }
 eye(){return this.pos.clone()}
 fwd(){return new THREE.Vector3(-Math.sin(this.yaw)*Math.cos(this.pitch),Math.sin(this.pitch),-Math.cos(this.yaw)*Math.cos(this.pitch)).normalize()}
 feetY(){return this.pos.y-EYE}

 update(dt,inp,jump){
  const f=new THREE.Vector3(-Math.sin(this.yaw),0,-Math.cos(this.yaw));
  const r=new THREE.Vector3(Math.cos(this.yaw),0,-Math.sin(this.yaw));
  const mv=new THREE.Vector3();
  mv.addScaledVector(f,inp.z);mv.addScaledVector(r,inp.x);
  if(mv.lengthSq()>0)mv.normalize();

  this.vel.x=mv.x*MSPD;this.vel.z=mv.z*MSPD;
  this.vel.y-=GRAV*dt;
  if(jump&&this.grounded){this.vel.y=JVEL;this.grounded=false}

  const np=this.pos.clone();
  np.x+=this.vel.x*dt;np.y+=this.vel.y*dt;np.z+=this.vel.z*dt;

  this._collide(np);
  this.pos.copy(np);
  cam.position.copy(this.eye());
  cam.lookAt(this.eye().add(this.fwd()));
 }

 _collide(np){
  // Player body: feet at (np.y - EYE), top at (np.y - EYE + PH)
  // So feet = np.y - 1.6, top = np.y - 1.6 + 1.8 = np.y + 0.2
  const r=PR;
  this.grounded=false;

  // â”€â”€ Y axis â”€â”€
  if(this.vel.y<0){
   const feetY=np.y-EYE; // feet position
   const fy=Math.floor(feetY);
   if(this._checkXZ(np.x,fy,np.z,r)){
    np.y=fy+1+EYE; // stand on top of block
    this.vel.y=0;this.grounded=true;
   }
  }else if(this.vel.y>0){
   const headY=np.y-EYE+PH; // top of player = feetY + 1.8
   const hy=Math.floor(headY);
   if(this._checkXZ(np.x,hy,np.z,r)){
    np.y=hy-PH+EYE; // push down so head doesn't clip
    this.vel.y=0;
   }
  }

  // â”€â”€ X axis â”€â”€ check all blocks the body occupies vertically
  const feetBlock=Math.floor(np.y-EYE);
  const headBlock=Math.floor(np.y-EYE+PH-0.01);
  for(let cy=feetBlock;cy<=headBlock;cy++){
   if(world.isS(Math.floor(np.x+r),cy,Math.floor(np.z))||
      world.isS(Math.floor(np.x-r),cy,Math.floor(np.z))){
    np.x=this.pos.x;this.vel.x=0;break;
   }
  }

  // â”€â”€ Z axis â”€â”€
  for(let cy=feetBlock;cy<=headBlock;cy++){
   if(world.isS(Math.floor(np.x),cy,Math.floor(np.z+r))||
      world.isS(Math.floor(np.x),cy,Math.floor(np.z-r))){
    np.z=this.pos.z;this.vel.z=0;break;
   }
  }

  // Floor clamp
  if(np.y<1+EYE){np.y=1+EYE;this.vel.y=0;this.grounded=true}
 }

 _checkXZ(x,y,z,r){
  return world.isS(Math.floor(x-r),y,Math.floor(z-r))||
         world.isS(Math.floor(x+r),y,Math.floor(z-r))||
         world.isS(Math.floor(x-r),y,Math.floor(z+r))||
         world.isS(Math.floor(x+r),y,Math.floor(z+r));
 }
}

let player;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RAYCASTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function raycast(md=7){
 const o=player.eye(),d=player.fwd();let prev=null;
 for(let t=0;t<md;t+=.04){
  const px=Math.floor(o.x+d.x*t),py=Math.floor(o.y+d.y*t),pz=Math.floor(o.z+d.z*t);
  if(world.isS(px,py,pz))return{hit:{x:px,y:py,z:pz},place:prev};
  prev={x:px,y:py,z:pz};
 }
 return null;
}

const hlM=new THREE.Mesh(
 new THREE.BoxGeometry(1.005,1.005,1.005),
 new THREE.MeshBasicMaterial({color:0xffffff,wireframe:true,transparent:true,opacity:.35})
);hlM.visible=false;scene.add(hlM);

function doBreak(){
 const r=raycast();
 if(r&&r.hit){world.setB(r.hit.x,r.hit.y,r.hit.z,0);bcastBlk(r.hit.x,r.hit.y,r.hit.z,0)}
}
function doPlace(){
 const r=raycast();
 if(!r||!r.place)return;
 const bt=HBB[player.slot];
 // Check player body collision
 const fx=Math.floor(player.pos.x),fz=Math.floor(player.pos.z);
 const feetB=Math.floor(player.pos.y-EYE);
 const headB=Math.floor(player.pos.y-EYE+PH-0.01);
 const p=r.place;
 if(p.x===fx&&p.z===fz&&p.y>=feetB&&p.y<=headB)return;
 world.setB(p.x,p.y,p.z,bt);bcastBlk(p.x,p.y,p.z,bt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REMOTE PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const remotes=new Map();

function mkModel(nick,color){
 const g=new THREE.Group();
 const c=new THREE.Color(color);
 const bm=new THREE.MeshLambertMaterial({color:c});
 const body=new THREE.Mesh(new THREE.BoxGeometry(.6,1.1,.35),bm);g.add(body);
 const hm=new THREE.MeshLambertMaterial({color:c.clone().multiplyScalar(1.15)});
 const head=new THREE.Mesh(new THREE.BoxGeometry(.48,.48,.48),hm);head.position.y=.8;g.add(head);
 const em=new THREE.MeshBasicMaterial({color:0xffffff});
 const el=new THREE.Mesh(new THREE.BoxGeometry(.09,.07,.02),em);el.position.set(-.11,.85,-.25);g.add(el);
 const er=new THREE.Mesh(new THREE.BoxGeometry(.09,.07,.02),em);er.position.set(.11,.85,-.25);g.add(er);
 const pm=new THREE.MeshBasicMaterial({color:0x222222});
 const pl=new THREE.Mesh(new THREE.BoxGeometry(.04,.04,.02),pm);pl.position.set(-.11,.84,-.26);g.add(pl);
 const pr=new THREE.Mesh(new THREE.BoxGeometry(.04,.04,.02),pm);pr.position.set(.11,.84,-.26);g.add(pr);
 const lm=new THREE.MeshLambertMaterial({color:c.clone().multiplyScalar(.72)});
 const la=new THREE.Mesh(new THREE.BoxGeometry(.22,.85,.28),lm);la.position.set(-.4,-.04,0);g.add(la);
 const ra=new THREE.Mesh(new THREE.BoxGeometry(.22,.85,.28),lm);ra.position.set(.4,-.04,0);g.add(ra);
 const lm2=lm.clone();
 const ll=new THREE.Mesh(new THREE.BoxGeometry(.26,.75,.28),lm2);ll.position.set(-.15,-.95,0);g.add(ll);
 const rl=new THREE.Mesh(new THREE.BoxGeometry(.26,.75,.28),lm2);rl.position.set(.15,-.95,0);g.add(rl);

 // Nametag
 const cv=document.createElement('canvas');cv.width=256;cv.height=48;
 const ctx=cv.getContext('2d');
 ctx.fillStyle='rgba(0,0,0,.55)';ctx.beginPath();ctx.roundRect(0,0,256,48,10);ctx.fill();
 ctx.font='bold 22px Segoe UI,Arial';ctx.fillStyle='#fff';ctx.textAlign='center';ctx.textBaseline='middle';
 ctx.fillText(nick||'Player',128,26);
 const tex=new THREE.CanvasTexture(cv);
 const lbl=new THREE.Mesh(new THREE.PlaneGeometry(1.8,.36),new THREE.MeshBasicMaterial({map:tex,transparent:true,depthTest:false}));
 lbl.position.y=1.6;g.add(lbl);

 scene.add(g);
 return{group:g,la,ra,ll,rl,lbl,prevPos:new THREE.Vector3(),moving:false};
}

function updRemote(id,d){
 if(!remotes.has(id))remotes.set(id,mkModel(d.nick,d.color));
 const rp=remotes.get(id);
 const tgt=new THREE.Vector3(d.x,d.y,d.z);
 rp.moving=tgt.distanceTo(rp.prevPos)>.04;
 rp.prevPos.copy(tgt);
 rp.group.position.lerp(tgt,.25);
 rp.group.rotation.y=d.yaw||0;
 if(rp.moving){
  const sw=Math.sin(performance.now()*.008)*.5;
  rp.ll.rotation.x=sw;rp.rl.rotation.x=-sw;
  rp.la.rotation.x=-sw*.5;rp.ra.rotation.x=sw*.5;
 }else{rp.ll.rotation.x=rp.rl.rotation.x=rp.la.rotation.x=rp.ra.rotation.x=0}
 rp.lbl.lookAt(cam.position);
}

function rmRemote(id){if(remotes.has(id)){scene.remove(remotes.get(id).group);remotes.delete(id)}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETWORKING â€” PeerJS with STUN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let peer=null,isHost=false,conns=[];
let myNick='Steve',myColor='#4ade80',roomId='';
let gameOn=false,paused=false;

const logEl=$('log'),reconnEl=$('reconn');

function $(id){return document.getElementById(id)}

function genId(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let s='';for(let i=0;i<4;i++)s+=c[Math.random()*c.length|0];return s}
function genCol(){return`hsl(${[0,30,60,120,180,210,270,330][Math.random()*8|0]},65%,55%)`}

const ICE_CFG={
 iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:stun2.l.google.com:19302'},
  {urls:'stun:stun3.l.google.com:19302'},
  {urls:'stun:stun4.l.google.com:19302'}
 ]
};

function mkPeer(id){
 const cfg={
  debug:2,
  config:ICE_CFG
 };
 if(id)return new Peer(id,cfg);
 return new Peer(cfg);
}

function bcast(msg){const s=JSON.stringify(msg);conns.forEach(c=>{if(c.open)c.send(s)})}
function bcastBlk(x,y,z,b){if(gameOn)blkHist.push({x,y,z,b});bcast({t:'blk',x,y,z,b})}

function setupConn(conn,incoming){
 conn.on('open',()=>{
  conns.push(conn);updNet();
  setLog('ok',`ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½: ${conn.metadata?.nick||'Player'}`);

  if(isHost&&incoming){
   // Send world
   conn.send(JSON.stringify({t:'world',seed:wSeed,hist:blkHist}));
   const nick=conn.metadata?.nick||'Player';
   const jm={t:'join',nick};
   conns.forEach(c=>{if(c.open)c.send(JSON.stringify(jm))});
   addChat('âš¡',nick+' Ğ¿Ñ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ğ»ÑÑ','#4ade80');
  }
 });

 conn.on('data',raw=>{
  let msg;try{msg=typeof raw==='string'?JSON.parse(raw):raw}catch{return}
  handleMsg(msg,conn.peer);
 });

 conn.on('close',()=>{
  conns=conns.filter(c=>c!==conn);rmRemote(conn.peer);updNet();
  if(isHost){
   const nick=conn.metadata?.nick||'Player';
   bcast({t:'left',id:conn.peer,nick});
   addChat('âš¡',nick+' Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ','#ef4444');
  }
 });

 conn.on('error',err=>{
  console.warn('Conn error:',err);
  if(!isHost){reconnEl.style.display='block';setTimeout(()=>{reconnEl.style.display='none'},4000)}
 });
}

function handleMsg(msg,fromId){
 switch(msg.t){
  case 'pos':
   updRemote(fromId,msg);
   if(isHost){const rl=JSON.stringify(msg);conns.forEach(c=>{if(c.open&&c.peer!==fromId)c.send(rl)})}
   break;
  case 'blk':
   world.setB(msg.x,msg.y,msg.z,msg.b);
   if(gameOn)blkHist.push({x:msg.x,y:msg.y,z:msg.z,b:msg.b});
   if(isHost){const rl=JSON.stringify(msg);conns.forEach(c=>{if(c.open&&c.peer!==fromId)c.send(rl)})}
   break;
  case 'chat':
   addChat(msg.nick,msg.text,msg.color);
   if(isHost){const rl=JSON.stringify(msg);conns.forEach(c=>{if(c.open&&c.peer!==fromId)c.send(rl)})}
   break;
  case 'world':
   wSeed=msg.seed;noise=new Noise(wSeed);world=new World();
   if(msg.hist)for(const h of msg.hist){
    const cx=Math.floor(h.x/CS),cz=Math.floor(h.z/CS);
    const lx=((h.x%CS)+CS)%CS,lz=((h.z%CS)+CS)%CS;
    world.getChunk(cx,cz)[world._i(lx,h.y,lz)]=h.b;
    world.dirty.add(world._k(cx,cz));
   }
   break;
  case 'join':addChat('âš¡',msg.nick+' Ğ¿Ñ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ğ»ÑÑ','#4ade80');break;
  case 'left':rmRemote(msg.id);addChat('âš¡',msg.nick+' Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ','#ef4444');break;
 }
}

function updNet(){
 const n=1+conns.filter(c=>c.open).length;
 $('nTxt').textContent='ğŸ‘¤ '+n;$('plist').textContent='Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: '+n;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chatMsgs=$('chatMsgs'),chatInWrap=$('chatInWrap'),chatIn=$('chatIn');
let chatVis=false;

function addChat(nick,text,color){
 const el=document.createElement('div');el.className='cm';
 el.innerHTML=`<b style="color:${color||'#4ade80'}">${nick}:</b> ${text.replace(/</g,'&lt;')}`;
 chatMsgs.appendChild(el);chatMsgs.scrollTop=chatMsgs.scrollHeight;
 while(chatMsgs.children.length>50)chatMsgs.removeChild(chatMsgs.firstChild);
}
function sendChat(t){if(!t.trim())return;addChat(myNick,t,myColor);bcast({t:'chat',nick:myNick,text:t,color:myColor})}
function togChat(){
 chatVis=!chatVis;chatInWrap.style.display=chatVis?'block':'none';
 if(chatVis)chatIn.focus();else{chatIn.blur();chatIn.value=''}
}
chatIn.addEventListener('keydown',e=>{e.stopPropagation();if(e.key==='Enter'){sendChat(chatIn.value);togChat()}if(e.key==='Escape')togChat()});
$('chatBtnM').addEventListener('click',togChat);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={},md={x:0,z:0};let wJump=false,pLock=false;

document.addEventListener('keydown',e=>{
 if(chatVis)return;keys[e.code]=true;
 if(e.code==='Escape'&&gameOn)togPause();
 if(e.code==='KeyT'&&gameOn&&!paused){e.preventDefault();togChat()}
 if(e.code.startsWith('Digit')&&gameOn){const n=parseInt(e.code.replace('Digit',''))-1;if(n>=0&&n<HBB.length){player.slot=n;refHB()}}
});
document.addEventListener('keyup',e=>{if(!chatVis)keys[e.code]=false});

document.addEventListener('mousemove',e=>{
 if(!pLock||!gameOn||chatVis)return;
 player.yaw-=e.movementX*.002;
 player.pitch=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,player.pitch-e.movementY*.002));
});

ren.domElement.addEventListener('mousedown',e=>{
 if(!gameOn)return;
 if(!pLock&&!MOB){ren.domElement.requestPointerLock();return}
 if(e.button===0)doBreak();if(e.button===2)doPlace();
});
ren.domElement.addEventListener('contextmenu',e=>e.preventDefault());
document.addEventListener('pointerlockchange',()=>{
 pLock=document.pointerLockElement===ren.domElement;
 if(!pLock&&gameOn&&!MOB&&!paused)showPause();
});
document.addEventListener('wheel',e=>{
 if(!gameOn)return;
 player.slot=e.deltaY>0?(player.slot+1)%HBB.length:(player.slot-1+HBB.length)%HBB.length;
 refHB();
});

// â”€â”€ Mobile Touch â”€â”€
let joyOn=false,joyTid=null,joyC={x:0,y:0};
let camTid=null,camPrv={x:0,y:0};

function tStart(e){
 if(!gameOn)return;
 for(const t of e.changedTouches){
  const el=document.elementFromPoint(t.clientX,t.clientY);
  if(el&&(el.id==='joyBase'||el.id==='joyKnob'||el.id==='joyArea')){
   if(!joyOn){joyOn=true;joyTid=t.identifier;const r=$('joyBase').getBoundingClientRect();joyC={x:r.left+r.width/2,y:r.top+r.height/2}}
  }else if(el&&el.id==='mbJ'){wJump=true}
  else if(el&&el.id==='mbB'){doBreak()}
  else if(el&&el.id==='mbP'){doPlace()}
  else if(!el||(!el.classList.contains('mb')&&el.id!=='joyBase'&&el.id!=='joyKnob'&&!el.closest('.hs')&&el.id!=='chatBtnM')){
   if(camTid===null){camTid=t.identifier;camPrv={x:t.clientX,y:t.clientY}}
  }
 }
}
function tMove(e){
 if(!gameOn)return;e.preventDefault();
 for(const t of e.changedTouches){
  if(t.identifier===joyTid&&joyOn){
   const dx=t.clientX-joyC.x,dy=t.clientY-joyC.y;
   const mx=48,dist=Math.min(Math.sqrt(dx*dx+dy*dy),mx);
   const ang=Math.atan2(dy,dx);
   const nx=Math.cos(ang)*dist,ny=Math.sin(ang)*dist;
   $('joyKnob').style.transform=`translate(calc(-50% + ${nx}px),calc(-50% + ${ny}px))`;
   md.x=nx/mx;md.z=ny/mx;
  }
  if(t.identifier===camTid){
   player.yaw-=(t.clientX-camPrv.x)*.004;
   player.pitch=Math.max(-Math.PI/2+.01,Math.min(Math.PI/2-.01,player.pitch-(t.clientY-camPrv.y)*.004));
   camPrv={x:t.clientX,y:t.clientY};
  }
 }
}
function tEnd(e){
 for(const t of e.changedTouches){
  if(t.identifier===joyTid){joyOn=false;joyTid=null;md.x=md.z=0;$('joyKnob').style.transform='translate(-50%,-50%)'}
  if(t.identifier===camTid)camTid=null;
 }
 wJump=false;
}
document.addEventListener('touchstart',tStart,{passive:false});
document.addEventListener('touchmove',tMove,{passive:false});
document.addEventListener('touchend',tEnd,{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const hotbar=$('hotbar'),bnameEl=$('bname'),xyzEl=$('xyz');

function buildHB(){
 hotbar.innerHTML='';
 HBB.forEach((bt,i)=>{
  const s=document.createElement('div');s.className='hs'+(i===0?' act':'');
  const cv=document.createElement('canvas');cv.width=cv.height=16;
  const ctx=cv.getContext('2d');
  const tid=bTexIds(bt)[2];const src=mkTex(tid).image;ctx.drawImage(src,0,0,16,16);
  s.appendChild(cv);
  const sn=document.createElement('span');sn.className='sn';sn.textContent=i+1;s.appendChild(sn);
  s.addEventListener('click',()=>{player.slot=i;refHB()});
  s.addEventListener('touchstart',e=>{e.stopPropagation();player.slot=i;refHB()},{passive:true});
  hotbar.appendChild(s);
 });
}
function refHB(){
 hotbar.querySelectorAll('.hs').forEach((s,i)=>s.classList.toggle('act',i===player.slot));
 bnameEl.textContent=BT[HBB[player.slot]].n;
}

function togPause(){paused?hidePause():showPause()}
function showPause(){paused=true;$('pause').style.display='flex'}
function hidePause(){paused=false;$('pause').style.display='none';if(!MOB)ren.domElement.requestPointerLock()}
$('bResume').addEventListener('click',hidePause);
$('bQuit').addEventListener('click',()=>location.reload());

function setLog(type,text){
 const d={loading:'dl',ok:'dok',error:'derr'};
 logEl.innerHTML=`<span class="dot ${d[type]||''}"></span> ${text}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MENU LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('iNick').value='Player_'+(Math.random()*999|0);

// HOST
$('bHost').addEventListener('click',()=>{
 myNick=$('iNick').value.trim()||'Steve';
 myColor=genCol();roomId=genId();isHost=true;
 wSeed=Math.random()*999999|0;noise=new Noise(wSeed);world=new World();

 setLog('loading','ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº PeerJS Cloud...');

 const peerId='vxc-'+roomId.toLowerCase();
 peer=mkPeer(peerId);

 peer.on('open',id=>{
  setLog('ok','ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°! ID: '+roomId);
  $('roomBox').style.display='block';
  $('rId').textContent=roomId;
  $('plist').textContent='Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: 1';
  console.log('[NET] Peer open, id=',id);
 });

 peer.on('connection',conn=>{
  console.log('[NET] Incoming connection from',conn.peer);
  setupConn(conn,true);
 });

 peer.on('error',err=>{
  console.error('[NET] Peer error:',err);
  if(err.type==='unavailable-id'){
   roomId=genId();setLog('loading','ID Ğ·Ğ°Ğ½ÑÑ‚, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ '+roomId+'...');
   peer.destroy();
   const nid='vxc-'+roomId.toLowerCase();
   peer=mkPeer(nid);
   peer.on('open',()=>{
    setLog('ok','ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°! ID: '+roomId);
    $('roomBox').style.display='block';$('rId').textContent=roomId;
   });
   peer.on('connection',conn=>setupConn(conn,true));
  }else{setLog('error','ĞÑˆĞ¸Ğ±ĞºĞ° PeerJS: '+err.type+' â€” '+err.message)}
 });

 peer.on('disconnected',()=>{
  setLog('loading','ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº PeerJS...');
  console.log('[NET] Disconnected, reconnecting...');
  peer.reconnect();
 });
});

// Copy
$('bCopy').addEventListener('click',()=>{
 navigator.clipboard.writeText(roomId).then(()=>{
  $('bCopy').textContent='âœ… Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!';setTimeout(()=>{$('bCopy').textContent='ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ'},2000);
 }).catch(()=>{
  const ta=document.createElement('textarea');ta.value=roomId;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
  $('bCopy').textContent='âœ… Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!';setTimeout(()=>{$('bCopy').textContent='ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ'},2000);
 });
});

// Start
$('bPlay').addEventListener('click',()=>launchGame());

// Join show
$('bJoinS').addEventListener('click',()=>{$('mainC').style.display='none';$('joinBox').style.display='block';logEl.textContent=''});
$('bBack').addEventListener('click',()=>{$('joinBox').style.display='none';$('mainC').style.display='block';logEl.textContent=''});

// Connect
$('bConn').addEventListener('click',()=>{
 myNick=$('iNick').value.trim()||'Steve';
 myColor=genCol();
 const code=$('iRoom').value.trim().toUpperCase();
 if(code.length<3){setLog('error','Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹');return}
 isHost=false;

 setLog('loading','ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº PeerJS Cloud...');
 peer=mkPeer(null);

 peer.on('open',myId=>{
  console.log('[NET] My peer id:',myId);
  setLog('loading','Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ñ…Ğ¾ÑÑ‚Ğ¾Ğ¼ ('+code+')...');

  const conn=peer.connect('vxc-'+code.toLowerCase(),{
   metadata:{nick:myNick,color:myColor},
   reliable:true
  });

  const timeout=setTimeout(()=>{
   if(!conn.open){
    setLog('error','Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ğ´ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.');
    console.warn('[NET] Connection timeout');
   }
  },15000);

  conn.on('open',()=>{
   clearTimeout(timeout);
   conns.push(conn);
   setLog('ok','ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾! Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¸Ñ€Ğ°...');
   console.log('[NET] Connected to host!');
   setTimeout(()=>launchGame(),1200);
  });

  conn.on('data',raw=>{
   let msg;try{msg=typeof raw==='string'?JSON.parse(raw):raw}catch{return}
   handleMsg(msg,conn.peer);
  });

  conn.on('close',()=>{
   conns=conns.filter(c=>c!==conn);rmRemote(conn.peer);updNet();
   addChat('âš¡','Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ñ…Ğ¾ÑÑ‚Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾','#ef4444');
   reconnEl.style.display='block';setTimeout(()=>{reconnEl.style.display='none'},5000);
  });

  conn.on('error',e=>{
   clearTimeout(timeout);
   setLog('error','ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ: '+e.message);
   console.error('[NET] Connection error:',e);
  });
 });

 peer.on('error',err=>{
  console.error('[NET] Peer error:',err);
  if(err.type==='peer-unavailable'){setLog('error','ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° "'+code+'" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ğ´.')}
  else{setLog('error','ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: '+err.type)}
 });

 peer.on('disconnected',()=>{
  reconnEl.style.display='block';
  console.log('[NET] Disconnected, reconnecting...');
  peer.reconnect();
  setTimeout(()=>{reconnEl.style.display='none'},5000);
 });
});

function launchGame(){
 gameOn=true;
 $('menu').style.display='none';
 $('hud').style.display='block';
 if(MOB){$('mobUI').style.display='block';$('chatBtnM').style.display='block'}
 player=new Player();buildHB();refHB();updNet();
 if(!MOB)ren.domElement.requestPointerLock();
 addChat('ğŸŒ','Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ, '+myNick+'!','#4ade80');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let prevT=performance.now(),netAcc=0;

function loop(now){
 requestAnimationFrame(loop);
 const dt=Math.min((now-prevT)/1000,.05);prevT=now;
 if(!gameOn||paused){ren.render(scene,cam);return}

 // Input
 if(!MOB&&!chatVis){
  md.x=md.z=0;
  if(keys['KeyW']||keys['ArrowUp'])md.z=1;
  if(keys['KeyS']||keys['ArrowDown'])md.z=-1;
  if(keys['KeyA']||keys['ArrowLeft'])md.x=-1;
  if(keys['KeyD']||keys['ArrowRight'])md.x=1;
  wJump=!!keys['Space'];
 }

 player.update(dt,MOB?{x:md.x,z:-md.z}:{x:md.x,z:md.z},wJump);
 world.update(player.pos.x,player.pos.z);

 // Highlight
 const rc=raycast();
 if(rc&&rc.hit){hlM.visible=true;hlM.position.set(rc.hit.x+.5,rc.hit.y+.5,rc.hit.z+.5)}
 else hlM.visible=false;

 // Network
 netAcc+=dt;
 if(netAcc>=1/NHZ){
  netAcc=0;
  bcast({t:'pos',x:player.pos.x,y:player.pos.y,z:player.pos.z,yaw:player.yaw,nick:myNick,color:myColor});
 }

 remotes.forEach(rp=>rp.lbl.lookAt(cam.position));

 // HUD
 const p=player.pos;
 xyzEl.textContent=`${p.x.toFixed(1)}, ${p.y.toFixed(1)}, ${p.z.toFixed(1)}  |  ${(1/dt|0)} fps`;

 // Follow player
 skyM.position.set(p.x,p.y,p.z);
 sunV.position.set(p.x+50,p.y+90,p.z+35);
 sun.position.set(p.x+50,p.y+90,p.z+35);
 if(sun.target){sun.target.position.copy(p);sun.target.updateMatrixWorld()}

 cldG.children.forEach(c=>{c.position.x+=.3*dt;if(c.position.x>130)c.position.x=-130});

 ren.render(scene,cam);
}
requestAnimationFrame(loop);

window.addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight)});
</script>
</body>
</html>
